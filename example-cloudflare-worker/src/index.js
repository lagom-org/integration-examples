const ARTICLE = `<!DOCTYPE html><html lang="en"><head>  <meta charset="UTF-8">  <meta name="viewport" content="width=device-width, initial-scale=1.0">  <title>The Lagom Gazette</title>  <style>    body {      font-family: Georgia, serif;      margin: 0;      padding: 0;      color: #333;    }    .container {      display: flex;	  flex-wrap: wrap;	  max-width: 1000px;	  margin: 0 auto;    }    header {      background-color: #f5f5f5;      padding: 20px;      display: flex;      justify-content: space-between;      align-items: center;      width: 100%;  /* Header fills entire viewport width */	  border-bottom: 1px solid #ddd;    }    h1 {      font-size: 2em;      margin: 0;    }    nav {      display: flex;    }    nav a {      margin-right: 20px;      text-decoration: none;      color: #333;    }    main {	  padding-top: 10px;	  padding-right: 20px;	  padding-left: 20px;	  padding-bottom: 20px;      flex: 1;  /* Main content expands to fill space */    }    article {      margin-bottom: 40px;      border-bottom: 1px solid #ddd;      padding-bottom: 20px;    }    article h2 {      font-size: 1.5em;      margin-bottom: 5px;    }    article p {      line-height: 1.5;    }    aside {        width: 250px;        padding: 20px;        background-color: #f5f5f5;        border-left: 1px solid #ddd;    }  aside h3 {    font-style: italic;		margin: auto;		padding-left: 0px;		width: 90%;		padding-bottom: 15px;		padding-top: 10px;  }	aside li {		padding-bottom: 15px;		list-style-type: none;	}	aside ul {		margin: auto;		padding-left: 0px;		width: 90%;	}  header a {		color: inherit;		text-decoration: inherit; /* no underline */  }  a {    color: darkblue;  }  .nit {    font-style: italic;    font-size: 18px;    border-left: 4px solid crimson;    padding-left: 15px;    border-radius: 3px;    padding-top: 10px;    padding-bottom: 1px;  }  .explained {    color: crimson;    font-weight: bold;    user-select: none;  }  .nit p  {    padding-bottom: 15px;    margin: 0;  }  article p::after {    height: 100px;    margin-top: -100px;    pointer-events: none;    content: " ";    background: linear-gradient(0deg, #fff 0, rgba(255, 255, 255, 0) 6.25rem);    display: block;    z-index: 9999;    position: relative;  }  @media only screen and (max-width: 750px), only screen and (max-device-width: 750px) {    aside {      display: none;    }  }  </style></head><body>  <div class="container">    <header>      <a href="/"><h1>The Lagom Gazette</h1></a>      <nav>         <a href="http://localhost:1313">Back to lagom.org</a>      </nav>    </header>    <main>      <article>        <h2>Fusion Breakthrough: Scientists Ignite Miniature Star with Lasers</h2>        <p>Long considered the holy grail for achieving clean and sustainable energy, fusion has recently achieved a breakthrough. Scientists have successfully ignited a miniature star using powerful lasers, marking a significant step forward toward harnessing fusion energy. The experiment, conducted at the National Ignition Facility (NIF) in the United States, achieved a net gain of fusion energy, meaning more energy was produced than was required to trigger the reaction.</p>        <a href="#" onclick="(function a(event) { location.href = 'http://localhost:1313/payout?amount=100&provider=test-provider&cb=' + btoa(location.href) })()"> Pay 1 EUR with Lagom to read this article in full</a>        <br />      </article>      <div class="nit">        <p class="explained"> Lagom Explained:</p>        <p>Welcome to the micro-payment demo webpage.</p>        <p>Clicking on the link above ⤴️ will redirect you to the Lagom payment page.</p>        <p>The payment is handled simply through a link, inspect the page to learn more.</p>    </div>    </main>    <aside>        <h3>Science Fact Blast</h3>        <ul>			<li>A teaspoon of a neutron star would weigh about 6 billion tons.</li>            <li>Helium balloons float because helium is lighter than air.</li>            <li>A day on Venus is longer than a year on Venus.</li>            <li>There are more atoms in a glass of water than glasses of water in all the oceans.</li>            <li>Bananas are radioactive.</li>            <li>Water can exist in three states at the same time (this is called the triple point).</li>            <li>You can't taste food without saliva.</li>            <li>Hot water can freeze faster than cold water under certain conditions (this is called the Mpemba effect).</li>		</ul>    </aside>  </div></body></html>`
const FULL_ARTICLE = `<!DOCTYPE html><html lang="en"><head>  <meta charset="UTF-8">  <meta name="viewport" content="width=device-width, initial-scale=1.0">  <title>The Lagom Gazette</title>  <style>    body {      font-family: Georgia, serif;      margin: 0;      padding: 0;      color: #333;    }    .container {      display: flex;	  flex-wrap: wrap;	  max-width: 1000px;	  margin: 0 auto;    }    header {      background-color: #f5f5f5;      padding: 20px;      display: flex;      justify-content: space-between;      align-items: center;      width: 100%;  /* Header fills entire viewport width */	  border-bottom: 1px solid #ddd;    }    h1 {      font-size: 2em;      margin: 0;    }    nav {      display: flex;    }    nav a {      margin-right: 20px;      text-decoration: none;      color: #333;    }    main {	  padding-top: 10px;	  padding-right: 20px;	  padding-left: 20px;	  padding-bottom: 20px;      flex: 1;  /* Main content expands to fill space */    }    article {      margin-bottom: 40px;      border-bottom: 1px solid #ddd;      padding-bottom: 20px;    }    article h2 {      font-size: 1.5em;      margin-bottom: 5px;    }    article p {      line-height: 1.5;    }    aside {        width: 250px;        padding: 20px;        background-color: #f5f5f5;        border-left: 1px solid #ddd;    }    aside h3 {        font-style: italic;		margin: auto;		padding-left: 0px;		width: 90%;		padding-bottom: 15px;		padding-top: 10px;    }	aside li {		padding-bottom: 15px;		list-style-type: none;	}	aside ul {		margin: auto;		padding-left: 0px;		width: 90%;	}  header a {		color: inherit;		text-decoration: inherit; /* no underline */  }  a {    color: darkblue;  }  .nit {    font-style: italic;    font-size: 18px;    border-left: 4px solid crimson;    padding-left: 15px;    border-radius: 3px;    padding-top: 10px;    padding-bottom: 1px;  }  .explained {    color: crimson;    font-weight: bold;    user-select: none;  }  .nit p  {    line-height: 1.5;    padding-bottom: 15px;    margin: 0;  }  @media only screen and (max-width: 750px), only screen and (max-device-width: 750px) {    aside {      display: none;    }  }  </style></head><body>  <div class="container">    <header>      <a href="/"><h1>The Lagom Gazette</h1></a>      <nav>         <a href="http://localhost:1313">Back to lagom.org</a>      </nav>    </header>    <main>      <article>        <h2>Fusion Breakthrough: Scientists Ignite Miniature Star with Lasers</h2>        <p>Long considered the holy grail for achieving clean and sustainable energy, fusion has recently achieved a breakthrough. Scientists have successfully ignited a miniature star using powerful lasers, marking a significant step forward toward harnessing fusion energy. The experiment, conducted at the National Ignition Facility (NIF) in the United States, achieved a net gain of fusion energy, meaning more energy was produced than was required to trigger the reaction.</p>        <p>Fusion works by combining two lighter atoms, usually hydrogen isotopes, to form a heavier atom like helium. This process releases enormous amounts of energy, the same way our sun produces energy. Unlike nuclear fission, which powers today's nuclear plants, fusion doesn't produce long-lived radioactive waste and is virtually free of the risk of meltdowns.</p>        <p>While there is still a long road ahead before commercial power generation is possible, this landmark achievement signifies a crucial step toward a sustainable energy future. It opens up exciting possibilities for creating a virtually inexhaustible supply of clean energy that could revolutionize how we power our world.</p>      </article>      <div class="nit">        <p class="explained"> Lagom Explained:</p>        <p>This page was paid by the user, and the CDN (Fastly) verified the payment before serving the page.</p>        <p>This link is only valid for 10 seconds, allowing the user to load the page, while limiting sharing possibilities.</p>    </div>    </main>    <aside>        <h3>Science Fact Blast</h3>        <ul>			<li>A teaspoon of a neutron star would weigh about 6 billion tons.</li>            <li>Helium balloons float because helium is lighter than air.</li>            <li>A day on Venus is longer than a year on Venus.</li>            <li>There are more atoms in a glass of water than glasses of water in all the oceans.</li>            <li>Bananas are radioactive.</li>            <li>Water can exist in three states at the same time (this is called the triple point).</li>            <li>You can't taste food without saliva.</li>            <li>Hot water can freeze faster than cold water under certain conditions (this is called the Mpemba effect).</li>		</ul>    </aside>  </div></body></html>`

const LAGOM_SECRET = "04b3623a9f7c553c272e3d3def949e3ac781ff8145ee87f22defc7616dae3f86a165547706f5e381a4d70070b234109fdd8daf80167e673ceda05503eb0d3123"

function StringResp(msg) {
	return new Response(msg, { headers: { "content-type": "text/html;charset=UTF-8" } })
}

async function CheckLagomPayment(request, page, amount) {
	const url = new URL(request.url)
	const lguid = url.searchParams.get('lguid')
	const lgts = url.searchParams.get('lgts')
	const lgsig = url.searchParams.get('lgsig')
	const lgid = url.searchParams.get('lgid')
	const lgamt = url.searchParams.get('lgamt')
	const verif = lguid + lgid + lgts + url.pathname + lgamt

	// check if timestamp is within 10 seconds
	const nowSec = Math.floor(Date.now() / 1000)
	if (nowSec > parseInt(lgts) + 10) {
		return false
	}

	if (parseInt(lgamt) !== amount || page !== url.pathname) {
		return false
	}

	// check signature
	const hmac = await crypto.subtle.importKey('raw', new TextEncoder().encode(LAGOM_SECRET), { name: 'HMAC', hash: 'SHA-256' }, false, ['sign'])
	const signed = await crypto.subtle.sign('HMAC', hmac, new TextEncoder().encode(verif))
	const computed = Array.from(new Uint8Array(signed)).map(b => b.toString(16).padStart(2, '0')).join('')
	return lgsig === computed
}

export default {
	async fetch(request, env, ctx) {
		let path = new URL(request.url).pathname

		if (path === '/' && request.url.includes('lguid') && await CheckLagomPayment(request, "/", 100)) {
			return StringResp(FULL_ARTICLE)
		} else {
			return StringResp(ARTICLE)
		}
	},
};

